<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>PaddyTrack - Advanced Paddy Crop Classification & Monitoring</title>
    
    <script src="https://cdn.tailwindcss.com"></script>
    
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" crossorigin=""/>
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo=" crossorigin=""></script>
    
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.css"/>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet.draw/1.0.4/leaflet.draw.js"></script>

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">

    <style>
        /* Custom styles for the application */
        :root {
            --primary-color: #10b981; /* emerald-500 */
            --dark-bg: #0c1322;
            --panel-bg: rgba(17, 24, 39, 0.6);
            --border-color: rgba(255, 255, 255, 0.08);
        }
        html {
            scroll-behavior: smooth;
        }
        body {
            font-family: 'Inter', sans-serif;
            background-color: var(--dark-bg);
            color: #e5e7eb;
        }
        .glassmorphism {
            background: var(--panel-bg);
            backdrop-filter: blur(12px);
            -webkit-backdrop-filter: blur(12px);
            border: 1px solid var(--border-color);
        }
        .leaflet-container {
            background: #1f2937;
        }
        .chart-container {
            position: relative;
            height: 220px;
            width: 100%;
        }
        .hero-bg {
            background-image: url('https://images.unsplash.com/photo-1559402942-b42b1d0b1744?q=80&w=2070&auto=format&fit=crop');
            background-size: cover;
            background-position: center;
        }
        .btn-primary {
            @apply bg-emerald-600 text-white font-bold py-3 px-6 rounded-lg shadow-lg hover:bg-emerald-700 transition-all duration-300 transform hover:scale-105 disabled:bg-emerald-800 disabled:scale-100 disabled:cursor-not-allowed;
        }
         .btn-secondary {
            @apply bg-gray-700 text-white font-bold py-2 px-4 rounded-lg shadow-md hover:bg-gray-600 transition-all duration-300 disabled:bg-gray-800 disabled:cursor-not-allowed;
        }
        /* Custom scrollbar */
        ::-webkit-scrollbar { width: 8px; }
        ::-webkit-scrollbar-track { background: #1f2937; }
        ::-webkit-scrollbar-thumb { background: #4b5563; border-radius: 10px; }
        ::-webkit-scrollbar-thumb:hover { background: #6b7280; }

        /* Animation for hero text */
        .fade-in-up {
            animation: fadeInUp 1s ease-out forwards;
            opacity: 0;
        }
        @keyframes fadeInUp {
            from { opacity: 0; transform: translateY(20px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        /* Timeline styles */
        .timeline-item { @apply relative pl-8 pb-8; }
        .timeline-item:last-child { @apply pb-0; }
        .timeline-item::before { content: ''; @apply absolute left-3 top-1 w-px h-full bg-gray-600; }
        .timeline-dot { @apply absolute left-0 top-0 h-6 w-6 rounded-full bg-gray-700 border-4 border-gray-900 flex items-center justify-center; }
        .timeline-dot-inner { @apply h-2 w-2 rounded-full bg-emerald-400; }
        
        /* Leaflet Draw Toolbar Customization */
        .leaflet-draw-toolbar a { background-color: #374151 !important; color: #e5e7eb !important; border-radius: 4px !important; }
        .leaflet-draw-toolbar a:hover { background-color: #4b5563 !important; }

        /* Toast Notification */
        #toast {
            @apply fixed bottom-5 right-5 bg-emerald-500 text-white py-3 px-5 rounded-lg shadow-xl translate-y-20 opacity-0 transition-all duration-500 z-50;
        }
        #toast.show {
            @apply translate-y-0 opacity-100;
        }

        /* Loading Overlay */
        .loading-overlay {
            @apply absolute inset-0 bg-gray-900 bg-opacity-70 z-20 flex items-center justify-center transition-opacity duration-300;
        }
    </style>
</head>
<body class="overflow-x-hidden">

    <div id="landingPage">
        <header class="absolute top-0 left-0 w-full z-10 p-5">
            <nav class="container mx-auto flex justify-between items-center">
                <div class="text-2xl font-extrabold text-white tracking-wider">
                    <span class="text-emerald-400">Paddy</span>Track
                </div>
                <button id="launchDashboardBtn" class="btn-primary">Launch Dashboard</button>
            </nav>
        </header>

        <main class="hero-bg relative h-screen flex items-center justify-center text-white">
            <div class="absolute inset-0 bg-black opacity-70"></div>
            <div class="relative z-10 text-center px-4">
                <h1 class="text-5xl md:text-7xl font-extrabold mb-4 leading-tight fade-in-up" style="animation-delay: 0.2s;">Advanced Paddy Crop Classification & Monitoring</h1>
                <p class="text-lg md:text-xl text-gray-300 max-w-3xl mx-auto fade-in-up" style="animation-delay: 0.4s;">
                    A scalable system for precise paddy crop detection, classification, and monitoring using satellite imagery and modern machine learning.
                </p>
            </div>
        </main>

        <div class="bg-gray-900">
             <section class="py-20">
                <div class="container mx-auto text-center">
                    <h2 class="text-4xl font-bold mb-12">Core Features</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-10 px-10">
                        <div class="glassmorphism p-8 rounded-2xl text-center transition-all duration-300 hover:border-emerald-400/50 hover:scale-105">
                             <svg class="w-16 h-16 mx-auto mb-4 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 17.25v-.934a.375.375 0 0 1 .11-.253l4.586-4.586a.375.375 0 0 1 .53 0l4.586 4.586a.375.375 0 0 1 .11.253v.934a1.875 1.875 0 0 1-1.875 1.875H10.875A1.875 1.875 0 0 1 9 17.25Z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M12 21.75a9.715 9.715 0 0 1-6.172-2.223 9.715 9.715 0 0 1-2.223-6.172c0-2.612 1.03-5.07 2.88-6.919a9.715 9.715 0 0 1 6.919-2.88c2.612 0 5.07 1.03 6.919 2.88a9.715 9.715 0 0 1 2.88 6.919 9.715 9.715 0 0 1-2.223 6.172A9.715 9.715 0 0 1 12 21.75Z"></path></svg>
                            <h3 class="text-2xl font-bold mb-2">Detect & Classify</h3>
                            <p class="text-gray-400">State-of-the-art ML & DL models for precise crop classification.</p>
                        </div>
                        <div class="glassmorphism p-8 rounded-2xl text-center transition-all duration-300 hover:border-emerald-400/50 hover:scale-105">
                            <svg class="w-16 h-16 mx-auto mb-4 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M2.25 18 9 11.25l4.306 4.306a11.95 11.95 0 0 1 5.814-5.518l2.74-1.22m0 0-5.94-2.28m5.94 2.28L21.75 12M2.25 18v3.75a.75.75 0 0 0 .75.75h3.75m0-3.75L6 21m15-9-3.75-1.5M12 9.75l-3.75-1.5M3 12l3.75 1.5m12-3.75-3.75 1.5m-6 0L9 12.75"></path></svg>
                            <h3 class="text-2xl font-bold mb-2">Track Crop Health</h3>
                            <p class="text-gray-400">Monitor crop vitality and growth stages throughout the season.</p>
                        </div>
                        <div class="glassmorphism p-8 rounded-2xl text-center transition-all duration-300 hover:border-emerald-400/50 hover:scale-105">
                            <svg class="w-16 h-16 mx-auto mb-4 text-emerald-400" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10.5 6a7.5 7.5 0 1 0 7.5 7.5h-7.5V6Z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13.5 10.5H21A7.5 7.5 0 0 0 13.5 3v7.5Z"></path></svg>
                            <h3 class="text-2xl font-bold mb-2">Generate Actionable Insights</h3>
                            <p class="text-gray-400">Gain insights with detailed charts, downloadable reports, and evaluation metrics.</p>
                        </div>
                    </div>
                </div>
            </section>

            <section class="py-20 bg-gray-900">
                <div class="container mx-auto px-10">
                    <h2 class="text-4xl font-bold mb-16 text-center">From Data to Insight: Our Workflow</h2>
                    <div class="grid grid-cols-1 md:grid-cols-3 gap-8">
                        <div class="text-center">
                            <div class="text-5xl font-extrabold text-emerald-400/30 mb-2">01</div>
                            <h3 class="text-xl font-bold mb-2">Data Collection & Preprocessing</h3>
                            <p class="text-gray-400">We acquire satellite data from Sentinel and Landsat, applying atmospheric correction and cloud masking to ensure data quality.</p>
                        </div>
                         <div class="text-center">
                            <div class="text-5xl font-extrabold text-emerald-400/30 mb-2">02</div>
                            <h3 class="text-xl font-bold mb-2">Feature Engineering & Model Training</h3>
                            <p class="text-gray-400">Key spectral indices (NDVI, NDWI, EVI) are calculated before training our advanced ML and DL models on the prepared data.</p>
                        </div>
                         <div class="text-center">
                            <div class="text-5xl font-extrabold text-emerald-400/30 mb-2">03</div>
                            <h3 class="text-xl font-bold mb-2">Assessment & Visualization</h3>
                            <p class="text-gray-400">Models are rigorously evaluated for accuracy, and results are presented in an intuitive dashboard with maps, charts, and reports.</p>
                        </div>
                    </div>
                </div>
            </section>

             <section class="py-20">
                <div class="container mx-auto text-center px-10">
                    <h2 class="text-4xl font-bold mb-4">Built on a Powerful Tech Stack</h2>
                    <p class="text-lg text-gray-400 max-w-2xl mx-auto mb-12">We use industry-leading tools to deliver a robust, scalable, and user-friendly platform.</p>
                    <div class="flex justify-center items-center flex-wrap gap-8 text-gray-400">
                        <span class="font-semibold text-lg">Python</span>
                        <span class="font-semibold text-lg">Google Earth Engine</span>
                        <span class="font-semibold text-lg">QGIS</span>
                        <span class="font-semibold text-lg">Random Forest</span>
                        <span class="font-semibold text-lg">U-Net</span>
                        <span class="font-semibold text-lg">Transformer</span>
                        <span class="font-semibold text-lg">Leaflet.js</span>
                        <span class="font-semibold text-lg">Chart.js</span>
                    </div>
                </div>
            </section>
        </div>
    </div>

    <div id="appDashboard" class="hidden h-screen w-screen grid grid-cols-12 grid-rows-12 gap-4 p-4 bg-gray-900">
        <header class="col-span-12 row-span-1 glassmorphism rounded-xl flex items-center justify-between p-4">
            <div class="text-2xl font-extrabold text-white tracking-wider">
                <span class="text-emerald-400">Paddy</span>Track <span class="text-sm font-normal text-gray-400">| Dashboard</span>
            </div>
             <button id="backToLandingBtn" class="btn-secondary">Back to Home</button>
        </header>

        <div class="col-span-12 md:col-span-3 row-span-11 glassmorphism rounded-xl p-4 overflow-y-auto">
            <h3 class="text-xl font-bold mb-4 border-b border-gray-600 pb-2">Analysis Setup</h3>
            
            <div class="mb-4">
                <label for="studyArea" class="block text-sm font-medium text-gray-300 mb-2">1. Area of Interest (AOI)</label>
                <select id="studyArea" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white focus:ring-emerald-500 focus:border-emerald-500">
                    <option value="default" disabled selected>Select a Study Area</option>
                    <option value="eastern_up">Eastern UP</option>
                    <option value="tamil_nadu">Tamil Nadu Delta</option>
                    <option value="punjab">Punjab</option>
                    <option value="west_bengal">West Bengal</option>
                </select>
                <p class="text-xs text-gray-500 mt-1">Or use the drawing tools on the map.</p>
            </div>

            <div class="mb-4">
                <label for="satellite" class="block text-sm font-medium text-gray-300 mb-2">2. Data Source</label>
                <select id="satellite" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white">
                    <option value="sentinel-2">Sentinel-2 (10m, Optical)</option>
                    <option value="sentinel-1">Sentinel-1 (20m, SAR - Cloud Penetrating)</option>
                    <option value="landsat-8">Landsat-8 (30m, Optical)</option>
                    <option value="planetscope" disabled>PlanetScope (3m, Premium)</option>
                </select>
            </div>

            <div class="mb-4">
                 <label class="block text-sm font-medium text-gray-300 mb-2">3. Date Range</label>
                 <div class="grid grid-cols-2 gap-2">
                     <input type="date" id="dateStart" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white" value="2023-06-01">
                     <input type="date" id="dateEnd" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white" value="2023-10-31">
                 </div>
            </div>

            <div class="mb-4">
                <label for="model" class="block text-sm font-medium text-gray-300 mb-2">4. Classification Model</label>
                <select id="model" class="w-full bg-gray-700 border border-gray-600 rounded-lg p-2 text-white">
                    <optgroup label="Machine Learning">
                        <option value="rf">Random Forest (RF)</option>
                        <option value="svm">Support Vector Machine (SVM)</option>
                        <option value="xgboost">XGBoost</option>
                    </optgroup>
                    <optgroup label="Deep Learning">
                        <option value="unet">U-Net</option>
                        <option value="tempcnn">TempCNN</option>
                        <option value="transformer">Transformer</option>
                    </optgroup>
                </select>
                <p class="text-xs text-gray-500 mt-1">Models leverage semi-supervised learning techniques.</p>
            </div>
            
            <div class="mb-4">
                <label for="cloudCover" class="block text-sm font-medium text-gray-300 mb-2">5. Cloud Cover Tolerance</label>
                <input type="range" id="cloudCover" min="0" max="100" value="20" class="w-full h-2 bg-gray-600 rounded-lg appearance-none cursor-pointer">
                <div class="text-right text-xs text-gray-400 mt-1"><span id="cloudCoverValue">20</span>%</div>
            </div>
            
            <div class="mt-6">
                <button id="runAnalysisBtn" class="w-full btn-primary">Run Analysis</button>
            </div>
            
            <div id="preprocessingSteps" class="mt-6 hidden">
                <h4 class="font-semibold mb-3 text-emerald-400">Analysis Status</h4>
                <ul class="space-y-2 text-sm">
                    <li id="step-0" class="flex items-center text-gray-500 transition-colors duration-500"><svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>Connecting to GEE...</li>
                    <li id="step-1" class="flex items-center text-gray-500 transition-colors duration-500"><svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>Atmospheric correction</li>
                    <li id="step-2" class="flex items-center text-gray-500 transition-colors duration-500"><svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>Cloud masking</li>
                    <li id="step-3" class="flex items-center text-gray-500 transition-colors duration-500"><svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>Feature engineering (NDVI, etc.)</li>
                    <li id="step-4" class="flex items-center text-gray-500 transition-colors duration-500"><svg class="w-4 h-4 mr-2" fill="currentColor" viewBox="0 0 20 20"><path fill-rule="evenodd" d="M10 18a8 8 0 100-16 8 8 0 000 16zm3.707-9.293a1 1 0 00-1.414-1.414L9 10.586 7.707 9.293a1 1 0 00-1.414 1.414l2 2a1 1 0 001.414 0l4-4z" clip-rule="evenodd"></path></svg>Running classification model...</li>
                </ul>
            </div>
        </div>

        <div class="col-span-12 md:col-span-6 row-span-11 glassmorphism rounded-xl p-1 relative" id="mapContainer">
            <div id="map" class="w-full h-full rounded-lg z-10"></div>
             <div class="absolute top-2 right-2 z-10 glassmorphism p-2 rounded-lg">
                <label class="block text-xs font-medium text-gray-300 mb-1">Feature Layers</label>
                <select id="featureLayer" class="w-full bg-gray-700/80 border border-gray-600 rounded-md p-1 text-xs text-white" disabled>
                    <option value="classification">Paddy Classification</option>
                    <option value="ndvi">NDVI</option>
                    <option value="ndwi">NDWI</option>
                    <option value="evi">EVI</option>
                </select>
            </div>
            <div id="hotspot-control" class="absolute bottom-4 left-4 z-10 bg-emerald-600/80 backdrop-blur-sm p-2 rounded-lg hidden shadow-lg">
                <button id="hotspotBtn" class="text-white font-bold py-2 px-3 text-sm hover:bg-emerald-700 rounded-md transition-all">Show Risk Hotspots</button>
            </div>
            <div id="map-loader" class="loading-overlay hidden opacity-0">
                 <div class="text-center">
                    <svg class="animate-spin h-10 w-10 text-emerald-400 mx-auto" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
                    <p id="loader-text" class="mt-2 text-lg font-semibold">Running Analysis...</p>
                </div>
            </div>
        </div>

        <div class="col-span-12 md:col-span-3 row-span-11 glassmorphism rounded-xl p-4 overflow-y-auto relative">
             <div id="results-loader" class="loading-overlay hidden opacity-0"></div>
            <h3 class="text-xl font-bold mb-4 border-b border-gray-600 pb-2">Results & Insights</h3>
            
            <div id="resultsContent" class="hidden space-y-6">
                <div id="classification-module">
                    <h4 class="font-semibold mb-2 text-emerald-400">Classification Metrics</h4>
                    <div class="grid grid-cols-2 gap-3 text-sm bg-gray-800 p-3 rounded-lg">
                        <p><strong>Accuracy:</strong><br><span id="accuracy" class="text-xl font-bold">0%</span></p>
                        <p><strong>Kappa:</strong><br><span id="kappa" class="text-xl font-bold">0.00</span></p>
                        <p><strong>Precision:</strong><br><span id="precision" class="text-xl font-bold">0.00</span></p>
                        <p><strong>Recall:</strong><br><span id="recall" class="text-xl font-bold">0.00</span></p>
                        <p><strong>F1-Score:</strong><br><span id="f1score" class="text-xl font-bold">0.00</span></p>
                    </div>
                </div>
                
                <div id="growth-module">
                    <h4 class="font-semibold mb-2 text-emerald-400">Seasonal Growth Monitoring (NDVI)</h4>
                    <div class="chart-container bg-gray-800 p-2 rounded-lg">
                        <canvas id="temporalChart"></canvas>
                    </div>
                </div>

                <div id="landcover-module">
                    <h4 class="font-semibold mb-2 text-emerald-400">Land Cover Distribution</h4>
                    <div class="chart-container bg-gray-800 p-2 rounded-lg">
                        <canvas id="landCoverChart"></canvas>
                    </div>
                </div>

                <div id="yield-module">
                    <h4 class="font-semibold mb-2 text-emerald-400">Yield Estimation</h4>
                    <div class="grid grid-cols-2 gap-3 text-sm bg-gray-800 p-3 rounded-lg">
                        <p><strong>Estimated Yield:</strong><br><span id="yield-estimate" class="text-xl font-bold">0 t/ha</span></p>
                        <p><strong>Potential Range:</strong><br><span id="yield-range" class="text-base font-bold">0 - 0 t/ha</span></p>
                        <p class="col-span-2"><strong>Growth Stage:</strong><br><span id="growth-stage" class="text-base font-bold">N/A</span></p>
                    </div>
                    <div class="chart-container bg-gray-800 p-2 rounded-lg mt-4">
                        <canvas id="yieldChart"></canvas>
                    </div>
                </div>

                <div id="health-module">
                    <h4 class="font-semibold mb-2 text-emerald-400">Pest & Disease Risk</h4>
                    <div class="chart-container !h-48 bg-gray-800 p-2 rounded-lg">
                        <canvas id="riskGaugeChart"></canvas>
                    </div>
                    <ul class="text-sm bg-gray-800 p-3 rounded-lg space-y-1 mt-4">
                        <li>Potential Threats: <span id="threat-1">Brown Spot, Rice Blast, Stem Borer</span></li>
                    </ul>
                </div>

                <div id="water-module">
                   <h4 class="font-semibold mb-2 text-emerald-400">Water Management</h4>
                   <div class="bg-gray-800 p-3 rounded-lg mb-4">
                       <p id="irrigation-recommendation" class="text-center font-bold text-lg text-emerald-400">Run analysis for insights.</p>
                       <p class="text-xs text-center text-gray-400 mt-1">Evapotranspiration Rate: <span id="et-rate">-- mm/day</span></p>
                   </div>
                   <div class="chart-container bg-gray-800 p-2 rounded-lg">
                       <canvas id="soilMoistureChart"></canvas>
                   </div>
               </div>
                
                <div class="pt-4 border-t border-gray-700">
                   <button id="downloadReportBtn" class="w-full btn-secondary">Download Full Report</button>
                </div>
            </div>

            <div id="resultsPlaceholder" class="text-center text-gray-500 mt-10">
                <svg class="w-12 h-12 mx-auto mb-4" fill="none" stroke="currentColor" viewBox="0 0 24 24" xmlns="http://www.w3.org/2000/svg"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 19v-6a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v6m-6 0h6M9 19H5a2 2 0 0 1-2-2V7a2 2 0 0 1 2-2h14a2 2 0 0 1 2 2v10a2 2 0 0 1-2 2h-4M9 19v-6a2 2 0 0 1 2-2h2a2 2 0 0 1 2 2v6"></path></svg>
                <p>Run analysis to see results here.</p>
            </div>
        </div>
    </div>
    
    <div id="toast"></div>

    <script>
        document.addEventListener('DOMContentLoaded', function() {
            // --- Application State & Configuration ---
            const AppState = {
                isAnalyzing: false,
                latestResults: null,
                apiUrl: 'dishagupta.pythonanywhere.com', // Python Server URL
            };

            const Config = {
                studyAreas: {
                    eastern_up: { lat: 26.0, lng: 83.0, zoom: 7, geojson: {"type":"Feature","properties":{},"geometry":{"type":"Polygon","coordinates":[[[81,27],[84,27],[84,25],[81,25],[81,27]]]}}},
                    tamil_nadu: { lat: 10.7905, lng: 79.1378, zoom: 8, geojson: {"type":"Feature","properties":{},"geometry":{"type":"Polygon","coordinates":[[[78.5,11.5],[80,11.5],[80,10],[78.5,10],[78.5,11.5]]]}}},
                    punjab: { lat: 30.7333, lng: 76.7794, zoom: 7, geojson: {"type":"Feature","properties":{},"geometry":{"type":"Polygon","coordinates":[[[74,32],[77,32],[77,30],[74,30],[74,32]]]}}},
                    west_bengal: { lat: 22.5726, lng: 88.3639, zoom: 7, geojson: {"type":"Feature","properties":{},"geometry":{"type":"Polygon","coordinates":[[[87,24],[89,24],[89,22],[87,22],[87,24]]]}}}
                },
            };

            // --- DOM Element References ---
            const DOM = {
                landingPage: document.getElementById('landingPage'),
                appDashboard: document.getElementById('appDashboard'),
                launchDashboardBtn: document.getElementById('launchDashboardBtn'),
                backToLandingBtn: document.getElementById('backToLandingBtn'),
                runAnalysisBtn: document.getElementById('runAnalysisBtn'),
                resultsContent: document.getElementById('resultsContent'),
                resultsPlaceholder: document.getElementById('resultsPlaceholder'),
                studyAreaSelect: document.getElementById('studyArea'),
                satelliteSelect: document.getElementById('satellite'),
                modelSelect: document.getElementById('model'),
                dateStartInput: document.getElementById('dateStart'),
                dateEndInput: document.getElementById('dateEnd'),
                preprocessingStepsEl: document.getElementById('preprocessingSteps'),
                cloudCoverSlider: document.getElementById('cloudCover'),
                cloudCoverValue: document.getElementById('cloudCoverValue'),
                mapLoader: document.getElementById('map-loader'),
                loaderText: document.getElementById('loader-text'),
                resultsLoader: document.getElementById('results-loader'),
                toast: document.getElementById('toast'),
                downloadReportBtn: document.getElementById('downloadReportBtn'),
                featureLayerSelect: document.getElementById('featureLayer'),
                hotspotBtn: document.getElementById('hotspotBtn'),
                hotspotControl: document.getElementById('hotspot-control'),
            };

            // --- Map Initialization ---
            const map = L.map('map').setView([26.8467, 80.9462], 7);
            L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
                attribution: '&copy; OpenStreetMap &copy; CARTO',
                subdomains: 'abcd', maxZoom: 20
            }).addTo(map);

            const drawnItems = new L.FeatureGroup();
            map.addLayer(drawnItems);
            const drawControl = new L.Control.Draw({
                edit: { featureGroup: drawnItems, remove: true },
                draw: {
                    polygon: { shapeOptions: { color: '#fbbf24' } },
                    polyline: false, rectangle: false, circle: false, marker: false, circlemarker: false
                }
            });
            map.addControl(drawControl);
            let classifiedLayer = null, hotspotLayer = null;

            // --- Chart Instances ---
            let landCoverChartInstance, temporalChartInstance, yieldChartInstance, riskGaugeChartInstance, soilMoistureChartInstance;

            // --- UI Manager ---
            const UIManager = {
                showDashboard: () => {
                    DOM.landingPage.classList.add('hidden');
                    DOM.appDashboard.classList.remove('hidden');
                    setTimeout(() => map.invalidateSize(), 10);
                },
                showLandingPage: () => {
                    DOM.appDashboard.classList.add('hidden');
                    DOM.landingPage.classList.remove('hidden');
                },
                showToast: (message) => {
                    DOM.toast.textContent = message;
                    DOM.toast.classList.add('show');
                    setTimeout(() => DOM.toast.classList.remove('show'), 3000);
                },
                setLoading: (isLoading, text = 'Running Analysis...') => {
                    AppState.isAnalyzing = isLoading;
                    DOM.runAnalysisBtn.disabled = isLoading;
                    DOM.downloadReportBtn.disabled = isLoading;
                    DOM.hotspotBtn.disabled = isLoading;
                    DOM.featureLayerSelect.disabled = !AppState.latestResults || isLoading;
                    DOM.loaderText.textContent = text;
                    
                    const toggleLoader = (loader, show) => {
                        if (show) {
                            loader.classList.remove('hidden');
                            setTimeout(() => loader.classList.remove('opacity-0'), 10);
                        } else {
                            loader.classList.add('opacity-0');
                            setTimeout(() => loader.classList.add('hidden'), 300);
                        }
                    };

                    if (isLoading) {
                        DOM.runAnalysisBtn.innerHTML = `<svg class="animate-spin h-5 w-5 mr-3 inline-block" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>Analyzing...`;
                        toggleLoader(DOM.mapLoader, true);
                        toggleLoader(DOM.resultsLoader, true);
                        DOM.resultsContent.classList.add('hidden');
                        DOM.hotspotControl.classList.add('hidden');
                        DOM.resultsPlaceholder.classList.remove('hidden');
                        DOM.preprocessingStepsEl.classList.remove('hidden');
                        for(let i = 0; i <= 4; i++) {
                            document.getElementById(`step-${i}`)?.classList.replace('text-emerald-400', 'text-gray-500');
                        }
                    } else {
                        DOM.runAnalysisBtn.textContent = 'Run Analysis Again';
                        toggleLoader(DOM.mapLoader, false);
                        toggleLoader(DOM.resultsLoader, false);
                        if (AppState.latestResults) {
                           DOM.downloadReportBtn.disabled = false;
                           DOM.hotspotBtn.disabled = false;
                           DOM.featureLayerSelect.disabled = false;
                           DOM.hotspotControl.classList.remove('hidden');
                        }
                    }
                },
                updateResults: (results) => {
                    DOM.resultsPlaceholder.classList.add('hidden');
                    DOM.resultsContent.classList.remove('hidden');
                    AppState.latestResults = results;
                    
                    if(classifiedLayer) map.removeLayer(classifiedLayer);
                    if(hotspotLayer) {
                        map.removeLayer(hotspotLayer);
                        hotspotLayer = null;
                        DOM.hotspotBtn.textContent = 'Show Risk Hotspots';
                    }
                    classifiedLayer = L.geoJSON(drawnItems.toGeoJSON(), {
                        style: { color: "#10b981", weight: 3, fillOpacity: 0.6 }
                    }).bindPopup("<b>Classified Paddy Area</b><br>High confidence.").addTo(map);

                    const animateValue = (id, start, end, duration, suffix = '', decimals = 0) => {
                        const obj = document.getElementById(id);
                        if (!obj) return;
                        let startTimestamp = null;
                        const step = (timestamp) => {
                            if (!startTimestamp) startTimestamp = timestamp;
                            const progress = Math.min((timestamp - startTimestamp) / duration, 1);
                            const value = progress * (end - start) + start;
                            obj.innerHTML = value.toFixed(decimals) + suffix;
                            if (progress < 1) window.requestAnimationFrame(step);
                        };
                        window.requestAnimationFrame(step);
                    };

                    animateValue("accuracy", 0, parseFloat(results.accuracy), 1000, "%", 1);
                    animateValue("kappa", 0, parseFloat(results.kappa), 1000, "", 2);
                    animateValue("precision", 0, parseFloat(results.precision), 1000, "", 2);
                    animateValue("recall", 0, parseFloat(results.recall), 1000, "", 2);
                    animateValue("f1score", 0, parseFloat(results.f1score), 1000, "", 2);

                    if (landCoverChartInstance) landCoverChartInstance.destroy();
                    landCoverChartInstance = new Chart(document.getElementById('landCoverChart').getContext('2d'), {
                        type: 'doughnut',
                        data: {
                            labels: ['Paddy', 'Water', 'Urban', 'Fallow Land'],
                            datasets: [{
                                data: results.landCover,
                                backgroundColor: ['rgba(16, 185, 129, 0.8)', 'rgba(59, 130, 246, 0.8)', 'rgba(107, 114, 128, 0.8)', 'rgba(202, 138, 4, 0.8)'],
                                borderColor: '#1f2937', borderWidth: 2
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { position: 'bottom', labels: { color: '#d1d5db', boxWidth: 12, padding: 15 } } } }
                    });

                    if (temporalChartInstance) temporalChartInstance.destroy();
                    temporalChartInstance = new Chart(document.getElementById('temporalChart').getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: ['Jun', 'Jul', 'Aug', 'Sep', 'Oct'],
                            datasets: [{
                                label: 'NDVI',
                                data: results.ndvi,
                                fill: true, backgroundColor: 'rgba(16, 185, 129, 0.2)', borderColor: 'rgba(16, 185, 129, 1)', tension: 0.3
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: '#9ca3af' } }, x: { ticks: { color: '#9ca3af' } } }, plugins: { legend: { display: false } } }
                    });

                    document.getElementById('yield-estimate').textContent = `${results.yield.estimate.toFixed(2)} t/ha`;
                    document.getElementById('yield-range').textContent = `${results.yield.range[0].toFixed(2)} - ${results.yield.range[1].toFixed(2)} t/ha`;
                    document.getElementById('growth-stage').textContent = results.yield.stage;

                    if (yieldChartInstance) yieldChartInstance.destroy();
                    yieldChartInstance = new Chart(document.getElementById('yieldChart').getContext('2d'), {
                        type: 'bar',
                        data: {
                            labels: ['Regional Average', 'Current Season Estimate'],
                            datasets: [{
                                label: 'Yield (t/ha)',
                                data: [results.yield.regionalAvg, results.yield.estimate],
                                backgroundColor: ['rgba(107, 114, 128, 0.8)', 'rgba(16, 185, 129, 0.8)'],
                                borderColor: ['#6b7280', '#10b981'],
                                borderWidth: 1
                            }]
                        },
                        options: { responsive: true, maintainAspectRatio: false, scales: { y: { beginAtZero: true, ticks: { color: '#9ca3af' } } }, plugins: { legend: { display: false } } }
                    });

                    if (riskGaugeChartInstance) riskGaugeChartInstance.destroy();
                    const riskValue = results.health.riskLevel;
                    const riskColor = riskValue < 40 ? '#22c55e' : riskValue < 75 ? '#f59e0b' : '#ef4444';
                    riskGaugeChartInstance = new Chart(document.getElementById('riskGaugeChart').getContext('2d'), {
                        type: 'doughnut',
                        data: {
                            labels: ['Risk Level', ''],
                            datasets: [{
                                data: [riskValue, 100 - riskValue],
                                backgroundColor: [riskColor, '#4b5563'],
                                borderColor: '#1f2937',
                                borderWidth: 2,
                                circumference: 180,
                                rotation: 270,
                            }]
                        },
                        options: {
                            responsive: true, maintainAspectRatio: false,
                            plugins: { legend: { display: false }, tooltip: { enabled: false } },
                            cutout: '80%'
                        }
                    });

                    document.getElementById('irrigation-recommendation').textContent = results.water.recommendation;
                    document.getElementById('et-rate').textContent = `${results.water.etRate} mm/day`;
                    
                    if (soilMoistureChartInstance) soilMoistureChartInstance.destroy();
                    soilMoistureChartInstance = new Chart(document.getElementById('soilMoistureChart').getContext('2d'), {
                        type: 'line',
                        data: {
                            labels: ['-6d', '-5d', '-4d', '-3d', '-2d', 'Yest', 'Today'],
                            datasets: [{
                                label: 'Soil Moisture Index',
                                data: results.water.soilMoisture,
                                borderColor: 'rgba(59, 130, 246, 1)',
                                tension: 0.3,
                                pointBackgroundColor: '#fff'
                            }]
                        },
                         options: { responsive: true, maintainAspectRatio: false, scales: { y: { ticks: { color: '#9ca3af' } }, x: { ticks: { color: '#9ca3af' } } }, plugins: { legend: { display: false } } }
                    });
                }
            };

            // --- Report Generator (Uses fetch to get TXT file from server) ---
            const ReportGenerator = {
                download: async () => {
                    if (!AppState.latestResults) {
                        UIManager.showToast("No results to download. Please run an analysis.");
                        return;
                    }

                    UIManager.showToast("Requesting report from server...");
                    DOM.downloadReportBtn.disabled = true;

                    const params = {
                        aoi: DOM.studyAreaSelect.value !== 'default' ? DOM.studyAreaSelect.options[DOM.studyAreaSelect.selectedIndex].text : 'Custom Drawn Area',
                        model: DOM.modelSelect.options[DOM.modelSelect.selectedIndex].text,
                        satellite: DOM.satelliteSelect.options[DOM.satelliteSelect.selectedIndex].text,
                        startDate: DOM.dateStartInput.value,
                        endDate: DOM.dateEndInput.value,
                        results: AppState.latestResults // Send current results back for inclusion in the report
                    };

                    try {
                        const response = await fetch(`${AppState.apiUrl}/download_report`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(params)
                        });

                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({})); 
                            throw new Error(errorData.error || `Server error: ${response.statusText}. Is the Python server running?`);
                        }

                        // Expecting a file (TXT) blob response
                        const blob = await response.blob();
                        const url = window.URL.createObjectURL(blob);
                        
                        const link = document.createElement('a');
                        link.href = url;
                        
                        // Set the filename to .txt, matching the backend output
                        link.setAttribute('download', 'PaddyTrack_Report.txt');

                        document.body.appendChild(link);
                        link.click();
                        link.parentNode.removeChild(link);
                        window.URL.revokeObjectURL(url);

                        UIManager.showToast("Report download started!");

                    } catch (error) {
                        console.error("Failed to download report:", error);
                        UIManager.showToast(`Download Error: ${error.message}`);
                    } finally {
                        if (!AppState.isAnalyzing) {
                            DOM.downloadReportBtn.disabled = false;
                        }
                    }
                }
            };

            // --- Analysis Runner (Uses fetch to get dynamic JSON from server) ---
            const AnalysisSimulator = {
                run: async () => {
                    if (drawnItems.getLayers().length === 0 && DOM.studyAreaSelect.value === "default") {
                        UIManager.showToast("Please select or draw an Area of Interest first.");
                        return;
                    }
                    UIManager.setLoading(true, 'Connecting to Python Server for Geo-Analysis...');

                    const runProgressSteps = async () => {
                         const steps = [
                            { duration: 500, text: 'Applying atmospheric corrections...', step: 1 },
                            { duration: 500, text: 'Masking clouds and shadows...', step: 2 },
                            { duration: 800, text: 'Engineering spectral features...', step: 3 },
                            { duration: 1000, text: 'Running classification model...', step: 4 },
                        ];
                        document.getElementById(`step-0`)?.classList.replace('text-gray-500', 'text-emerald-400');
                        for (const step of steps) {
                            await new Promise(resolve => {
                                UIManager.setLoading(true, step.text);
                                document.getElementById(`step-${step.step}`)?.classList.replace('text-gray-500', 'text-emerald-400');
                                setTimeout(resolve, step.duration);
                            });
                        }
                    };

                    try {
                        const progressPromise = runProgressSteps();

                        const analysisParams = {
                            studyArea: DOM.studyAreaSelect.value,
                            satellite: DOM.satelliteSelect.value,
                            model: DOM.modelSelect.value,
                            dateStart: DOM.dateStartInput.value,
                            dateEnd: DOM.dateEndInput.value,
                            cloudCover: DOM.cloudCoverSlider.value,
                            aoiGeoJson: drawnItems.toGeoJSON() // Send the AOI to the server
                        };
                        
                        // --- LIVE SERVER FETCH ---
                        const response = await fetch(`${AppState.apiUrl}/run_analysis`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/json' },
                            body: JSON.stringify(analysisParams)
                        });

                        if (!response.ok) {
                            const errorData = await response.json().catch(() => ({})); 
                            throw new Error(errorData.error || `Server error: ${response.statusText}. Is the Python server running?`);
                        }

                        const results = await response.json();


                        await progressPromise; 

                        UIManager.updateResults(results);
                        UIManager.showToast("Analysis complete! Results are from the Python server.");

                    } catch (error) {
                        console.error("Analysis failed:", error);
                        UIManager.showToast(`Connection Error: ${error.message}`);
                    } finally {
                        UIManager.setLoading(false);
                    }
                }
            };

            DOM.launchDashboardBtn.addEventListener('click', UIManager.showDashboard);
            DOM.backToLandingBtn.addEventListener('click', UIManager.showLandingPage);
            DOM.runAnalysisBtn.addEventListener('click', AnalysisSimulator.run);
            DOM.downloadReportBtn.addEventListener('click', ReportGenerator.download);

            DOM.studyAreaSelect.addEventListener('change', (e) => {
                const areaKey = e.target.value;
                if (areaKey !== "default" && Config.studyAreas[areaKey]) {
                    const area = Config.studyAreas[areaKey];
                    map.setView([area.lat, area.lng], area.zoom);
                    drawnItems.clearLayers();
                    const aoiLayer = L.geoJSON(area.geojson, { style: { color: "#fbbf24", weight: 2, fillOpacity: 0.1 } });
                    drawnItems.addLayer(aoiLayer);
                }
            });

            DOM.cloudCoverSlider.addEventListener('input', (e) => {
                DOM.cloudCoverValue.textContent = e.target.value;
            });
            
            DOM.hotspotBtn.addEventListener('click', () => {
                if (drawnItems.getLayers().length === 0) {
                    UIManager.showToast("Please define an Area of Interest first.");
                    return;
                }
                if (hotspotLayer) {
                    map.removeLayer(hotspotLayer);
                    hotspotLayer = null;
                    DOM.hotspotBtn.textContent = 'Show Risk Hotspots';
                    UIManager.showToast("Hotspot layer removed.");
                } else {
                    const bounds = drawnItems.getBounds();
                    const hotspots = [];
                    for(let i=0; i<5; i++) { 
                        const lat = bounds.getSouth() + Math.random() * (bounds.getNorth() - bounds.getSouth());
                        const lng = bounds.getWest() + Math.random() * (bounds.getEast() - bounds.getWest());
                        hotspots.push(L.circle([lat, lng], {
                            radius: 5000,
                            color: 'red',
                            fillColor: '#f03',
                            fillOpacity: 0.5
                        }));
                    }
                    hotspotLayer = L.featureGroup(hotspots).addTo(map);
                    DOM.hotspotBtn.textContent = 'Hide Risk Hotspots';
                    UIManager.showToast("Risk hotspots are now displayed on the map.");
                }
            });

            map.on(L.Draw.Event.CREATED, function (e) {
                drawnItems.clearLayers();
                drawnItems.addLayer(e.layer);
                DOM.studyAreaSelect.value = "default";
                UIManager.showToast("Area of Interest created successfully!");
            });
        });
    </script>
</body>
</html>